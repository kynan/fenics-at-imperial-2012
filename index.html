<!DOCTYPE html>
<html>
  <head>
    <title>Generating high-performance multiplatform finite element solvers from high-level descriptions</title>
    <meta charset='utf-8' />
    <meta content='width=1024, user-scalable=no' name='viewport' />
    <!-- deck.js's core css -->
    <link href="deck.js/core/deck.core.css" rel="stylesheet" type="text/css"/>
    <!-- deck.js extension CSS files -->
    <link href="deck.js/extensions/codemirror/deck.codemirror.css" rel="stylesheet" type="text/css"/>
    <link href="deck.js/extensions/hash/deck.hash.css" rel="stylesheet" type="text/css"/>
    <link href="deck.js/extensions/navigation/deck.navigation.css" rel="stylesheet" type="text/css"/>
    <link href="deck.js/extensions/goto/deck.goto.css" rel="stylesheet" type="text/css"/>
    <link href="deck.js/extensions/menu/deck.menu.css" rel="stylesheet" type="text/css"/>
    <link href="deck.js/extensions/scale/deck.scale.css" rel="stylesheet" type="text/css"/>
    <link href="deck.js/extensions/status/deck.status.css" rel="stylesheet" type="text/css"/>
    <!-- all css in the css dir: Keydown CSS, your custom CSS, and themes from deck.js -->
    <link href="css/keydown.css" rel="stylesheet" type="text/css"/>
    <link href="css/slides.css" rel="stylesheet" type="text/css"/>
    <link href="css/swiss.css" rel="stylesheet" type="text/css"/>
    <link href="css/default.css" rel="stylesheet" type="text/css"/>
    <link href="css/horizontal-slide.css" rel="stylesheet" type="text/css"/>
    <!-- Modernizr (provided for legacy browsers) -->
    <script src="deck.js/support/modernizr.custom.js" type="text/javascript"></script>
    <!-- deck.js navigation extension -->
    <a class='deck-prev-link' href='#' title='Previous'>&#8592;</a>
    <a class='deck-next-link' href='#' title='Next'>&#8594;</a>
    <!-- deck.js hash extension -->
    <a class='deck-permalink' href='.' title='Permalink to this slide'>#</a>
    <!-- deck.js status extension -->
    <p class='deck-status'>
      <span class='deck-status-current'></span>
      /
      <span class='deck-status-total'></span>
    </p>
    <!-- jQuery & deck.js -->
    <script src="deck.js/support/jquery.1.6.4.min.js" type="text/javascript"></script>
    <script src="deck.js/core/deck.core.js" type="text/javascript"></script>
    <!-- deck.js extension JS files -->
    <script src="deck.js/extensions/codemirror/introduction/modernizr.custom.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/introduction/introduction.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/codemirror.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/sparql/sparql.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/velocity/velocity.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/diff/diff.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/javascript/javascript.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/htmlmixed/htmlmixed.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/coffeescript/coffeescript.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/scheme/scheme.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/haskell/haskell.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/php/php.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/css/css.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/clojure/clojure.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/python/python.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/r/r.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/clike/clike.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/rst/rst.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/yaml/yaml.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/stex/stex.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/smalltalk/smalltalk.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/xmlpure/xmlpure.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/xml/xml.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/plsql/plsql.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/ruby/ruby.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/lua/lua.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/deck.codemirror.js" type="text/javascript"></script>
    <script src="deck.js/extensions/hash/deck.hash.js" type="text/javascript"></script>
    <script src="deck.js/extensions/navigation/deck.navigation.js" type="text/javascript"></script>
    <script src="deck.js/extensions/goto/deck.goto.js" type="text/javascript"></script>
    <script src="deck.js/extensions/menu/deck.menu.js" type="text/javascript"></script>
    <script src="deck.js/extensions/scale/deck.scale.js" type="text/javascript"></script>
    <script src="deck.js/extensions/status/deck.status.js" type="text/javascript"></script>
    <!-- your custom JS here, including call to initialize deck.js-codemirror -->
    <script src="js/slides.js" type="text/javascript"></script>
    <!-- Initialize the deck. -->
    <script type='text/javascript'>
      $(function() { $.deck('.slide'); });
    </script>
  </head>
  <body class='deck-container keydown'>
    <section class='left slide'>
      <div class='spacer top'></div>
      <div class='content'>
        <h1>Generating high-performance multiplatform finite element solvers from high-level descriptions</h1>
        
        <h2>Florian Rathgeber, Graham R. Markall, David A. Ham, Paul H. J. Kelly, Carlo Bertolli,  Adam Betts</h2>
        
        <h3>Imperial College London</h3>
        
        <h2>Mike B. Giles, Gihan R. Mudalige</h2>
        
        <h3>University of Oxford</h3>
        
        <h2>Istvan Z. Reguly</h2>
        
        <h3>Pazmany Peter Catholic University, Hungary</h3>
        
        <h2>Lawrence Mitchell</h2>
        
        <h3>University of Edinburgh</h3>
      </div>
      <div class='spacer bottom'></div>
    </section>
    <section class='huge slide'>
      <div class='spacer top'></div>
      <div class='content'>
        <h1>The challenge</h1>
        
        <blockquote><p>How do we get performance portability for the finite element method without sacrificing generality?</p></blockquote>
      </div>
      <div class='spacer bottom'></div>
    </section>
    <section class='left slide'>
      <div class='spacer top'></div>
      <div class='content'>
        <h1>The strategy</h1>
        
        <h2>Get the abstractions right</h2>
        
        <p>... to isolate numerical methods from their mapping to hardware</p>
        
        <h2>Start at the top, work your way down</h2>
        
        <p>... as the greatest opportunities are at the highest abstraction level</p>
        
        <h2>Harness the power of DSLs</h2>
        
        <p>... for generative, instead of transformative optimisations</p>
      </div>
      <div class='spacer bottom'></div>
    </section>
    <section class='left slide'>
  <div class='spacer top'></div>
  <div class='content'>
    <h1>The tools</h1>

<h2>Embedded domain-specific languages</h2>

<p>... capture and <em>efficiently express characteristics</em> of the application/problem domain</p>

<h2>Active libraries</h2>

<p>... encapsulate <em>specialist performance expertise</em> and deliver <em>domain-specific optimisations</em></p>

<h2>In combination, they</h2>

<ul>
<li>raise the level of abstraction and incorporate domain-specific knowledge</li>
<li>decouple problem domains from their efficient implementation on different hardware</li>
<li>capture design spaces and open optimisation spaces</li>
<li>enable reuse of code generation and optimisation expertise and tool chains</li>
</ul>
  </div>
  <div class='spacer bottom'></div>
</section>
    <section class='huge slide'>
      <div class='spacer top'></div>
      <div class='content'>
        <h1>The big picture</h1>
      </div>
      <div class='spacer bottom'></div>
    </section>
    <section class='full-background mapdes_abstraction_layers slide'>
      <div class='spacer top'></div>
      <div class='content'>
        
      </div>
      <div class='spacer bottom'></div>
    </section>
    <section class='huge slide'>
      <div class='spacer top'></div>
      <div class='content'>
        <h1>Higher level abstraction</h1>
        
        <h2>From the equation to the finite element implementation</h2>
      </div>
      <div class='spacer bottom'></div>
    </section>
    <section class='left slide'>
  <div class='spacer top'></div>
  <div class='content'>
    <h1>Manycore Form Compiler</h1>

<p><img src="images/mcfc_ffc.svg" alt="The DOLFIN-FFC and Fluidity-MCFC pipelines side-by-side" /></p>

<ul>
<li>Compile-time code generation, runtime coming soon</li>
<li>Generates assembly and marshaling code</li>
<li>Designed to handle isoparametric elements</li>
</ul>
  </div>
  <div class='spacer bottom'></div>
</section>
    <section class='left slide'>
  <div class='spacer top'></div>
  <div class='content'>
    <h1>MCFC takes equations in UFL</h1>
    
    <h2>Helmholtz equation</h2>
    
    <p><textarea class='code' display='none' mode='python'>f = state.scalar_fields["Tracer"]&#x000A;&#x000A;v=TestFunction(f)&#x000A;u=TrialFunction(f)&#x000A;&#x000A;lmbda = 1&#x000A;A = (dot(grad(v),grad(u))-lmbda*v*u)*dx&#x000A;&#x000A;RHS = v*f*dx&#x000A;&#x000A;solution = solve(A, RHS)&#x000A;state.scalar_fields["Tracer"] = solution</textarea>
</p>
  </div>
  <div class='spacer bottom'></div>
</section>
    <section class='left slide'>
  <div class='spacer top'></div>
  <div class='content'>
    <h1>... and generates local assembly kernels</h1>
    
    <h2>Helmholtz OP2 kernel</h2>
    
    <p><textarea class='code' display='none' mode='clike'>void A_0(double* lt, double* dt, double* c0[2], int i_r_0, int i_r_1) {&#x000A;  /* Shape functions/derivatives, quadrature weights */&#x000A;  double c_q0[6][2][2];&#x000A;  /* Evaluate coefficients at quadrature points */&#x000A;  for(int i_g = 0; i_g < 6; i_g++) {&#x000A;    double ST1 = 0.0, ST0 = 0.0, ST2 = 0.0;&#x000A;    ST1 += -1 * CG1[i_r_0][i_g] * CG1[i_r_1][i_g];&#x000A;    double l95[2][2] = { { c_q0[i_g][1][1], -1 * c_q0[i_g][0][1] },&#x000A;                         { -1 * c_q0[i_g][1][0], c_q0[i_g][0][0] } };&#x000A;    ST2 += c_q0[i_g][0][0] * c_q0[i_g][1][1]&#x000A;            + -1 * c_q0[i_g][0][1] * c_q0[i_g][1][0];&#x000A;    for(int i_d_5 = 0; i_d_5 < 2; i_d_5++) {&#x000A;      for(int i_d_3 = 0; i_d_3 < 2; i_d_3++) {&#x000A;        for(int i_d_9 = 0; i_d_9 < 2; i_d_9++) {&#x000A;          ST0 += (l95[i_d_3][i_d_5]&#x000A;            / (c_q0[i_g][0][0] * c_q0[i_g][1][1] + -1 * c_q0[i_g][0][1]&#x000A;                * c_q0[i_g][1][0])) * d_CG1[i_r_0][i_g][i_d_3]&#x000A;                * (l95[i_d_9][i_d_5] / (c_q0[i_g][0][0] * c_q0[i_g][1][1]&#x000A;                   + -1 * c_q0[i_g][0][1] * c_q0[i_g][1][0]))&#x000A;               * d_CG1[i_r_1][i_g][i_d_9];&#x000A;        }&#x000A;      }&#x000A;    }&#x000A;    lt[0] += ST2 * (ST0 + ST1) * w[i_g];&#x000A;  }&#x000A;}</textarea>
</p>
  </div>
  <div class='spacer bottom'></div>
</section>
    <section class='float left slide'>
  <div class='spacer top'></div>
  <div class='content'>
    <h1>MCFC Pipeline</h1>

<p><img src="images/mcfc_pipeline.svg" alt="The MCFC execution pipeline" /></p>

<ul>
<li><h2>Preprocessing</h2>

<p>transform integrands and spatial derivatives of forms by Jacobian determinant/inverse</p></li>
<li><h2>Execution</h2>

<p>evaluate preprocessed UFL input in namespace</p></li>
<li><h2>Form processing</h2>

<p>compute form metadate using UFL algorithms</p></li>
<li><h2>Partitioning</h2>

<p>segment integrand according to expression depth</p></li>
<li><h2>Expression generation</h2>

<p>determine integrand subexpression and insert into loop nest</p></li>
</ul>
  </div>
  <div class='spacer bottom'></div>
</section>
    <section class='left slide'>
  <div class='spacer top'></div>
  <div class='content'>
    <h1>Preprocessing</h1>

<h2>Coordinate transformations handled as part of the form</h2>

<p>using UFL primitives <code>Jacobian</code>, <code>Inverse</code> and <code>Determinant</code></p>

<p><textarea class='code' display='none' mode='python'>x = state.vector_fields['Coordinate']&#x000A;J = Jacobian(x)&#x000A;invJ = Inverse(J)&#x000A;detJ = Determinant(J)</textarea>
</p>

<ul>
<li>Pre-multiply each integrand by <code>detJ</code></li>
<li>Overload derivative operators:</li>
</ul>


<p><textarea class='code' display='none' mode='python'>def grad(u):&#x000A;    return ufl.dot(invJ, ufl.grad(u))</textarea>
</p>

<h2>No special treatment of the Jacobian, its determinant or inverse</h2>
  </div>
  <div class='spacer bottom'></div>
</section>
    <section class='left slide'>
  <div class='spacer top'></div>
  <div class='content'>
    <h1>Loop nest generation</h1>

<h2>Loops in typical assembly kernel:</h2>

<p><textarea class='code' display='none' mode='python'>for (int i=0; i<3; ++i)       // <- basis functions&#x000A;  for (int j=0; j<3; ++j)     // <- basis functions&#x000A;    for (int q=0; q<6; ++q)   // <- quadrature points&#x000A;      for (int d=0; d<2; ++d) // <- dimensions</textarea>
</p>

<h2>Inference of loop structure from preprocessed form:</h2>

<ul>
<li><strong>Basis functions:</strong> use rank of the form</li>
<li><strong>Quadrature loop:</strong> quadrature degree known</li>
<li><strong>Dimension loops:</strong> descend expression DAG, identifying maximal sub-graphs sharing a set of indices of an <code>IndexSum</code></li>
</ul>
  </div>
  <div class='spacer bottom'></div>
</section>
    <section class='left slide'>
  <div class='spacer top'></div>
  <div class='content'>
    <h1>Partitioning</h1>

<p><img src="images/helmholtz_partitioning.svg" alt="Partitioning the Helmholtz equation" /></p>

<ul>
<li>Generate a subexpression for each partition</li>
<li>Insert the subexpression into the loop nest depending on the indices it refers to</li>
<li>Traverse the topmost expression of the form, and generate an expression that combines subexpressions, and insert into loop nest</li>
</ul>
  </div>
  <div class='spacer bottom'></div>
</section>
    <section class='huge slide'>
      <div class='spacer top'></div>
      <div class='content'>
        <h1>Lower level abstraction</h1>
        
        <h2>From the finite element implementation to its efficient parallel execution</h2>
      </div>
      <div class='spacer bottom'></div>
    </section>
    <section class='left slide'>
      <div class='spacer top'></div>
      <div class='content'>
        <h1>OP2 – an active library for unstructured mesh computations</h1>
        
        <h2>Abstractions for unstructured grids</h2>
        
        <ul>
        <li><strong>Sets</strong> of entities (e.g. nodes, edges, faces)</li>
        <li><strong>Mappings</strong> between sets (e.g. from edges to nodes)</li>
        <li><strong>Datasets</strong> holding data on a set (i.e. fields in finite-element terms)</li>
        </ul>
        
        
        <h2>Mesh computations as parallel loops</h2>
        
        <ul>
        <li>execute a <em>kernel</em> for all members of one set in arbitrary order</li>
        <li>datasets accessed through at most one level of indirection</li>
        <li><em>access descriptors</em> specify which data is passed to the kernel and how it is addressed</li>
        </ul>
        
        
        <h2>Multiple hardware backends via <em>source-to-source translation</em></h2>
        
        <ul>
        <li>partioning/colouring for efficient scheduling and execution on different hardware</li>
        <li>currently supports CUDA/OpenMP + MPI - OpenCL, AVX support planned</li>
        </ul>
      </div>
      <div class='spacer bottom'></div>
    </section>
    <section class='left slide'>
      <div class='spacer top'></div>
      <div class='content'>
        <h1>OP2 for finite element computations</h1>
        
        <h2>Finite element local assembly</h2>
        
        <p>... means computing the <em>same kernel</em> for <em>every</em> mesh entity (cell, facet)</p>
        
        <h2>OP2 abstracts away data marshaling and parallel execution</h2>
        
        <ul>
        <li>controls whether/how/when a matrix is assembled</li>
        <li>OP2 has the choice: assemble a sparse (CSR) matrix, or keep the local assembly matrices (local matrix approach, LMA)</li>
        <li>local assembly kernel is <em>translated</em> for and <em>efficiently executed</em> on the target architecture</li>
        </ul>
        
        
        <h2>Global asssembly and linear algebra operations</h2>
        
        <p>... implemented as a thin wrapper on top of backend-specific linear algebra packages:<br/>
        <em>PETSc</em> on the CPU, <em>Cusp</em> on the GPU</p>
      </div>
      <div class='spacer bottom'></div>
    </section>
    <section class='left slide'>
  <div class='spacer top'></div>
  <div class='content'>
    <h1>MCFC generates OP2 "glue code"</h1>

<h2>OP2 host code calling the generated kernels:</h2>

<p><textarea class='code' display='none' mode='clike'>extern "C" void run_model_(double* dt_pointer)&#x000A;{&#x000A;  /* ... data marshaling */&#x000A;  op_sparsity A_sparsity = op_decl_sparsity( /* ... */ );&#x000A;  op_mat A_mat = op_decl_mat(A_sparsity,  /* ... */ );&#x000A;  op_par_loop(A_0, "A_0", op_iteration_space(Tracer.map->from, 3, 3),&#x000A;              op_arg_mat(A_mat, OP_ALL, Tracer.map, OP_ALL, Tracer.map,&#x000A;                         Tracer.dat->dim, "double", OP_INC),&#x000A;              op_arg_gbl(dt_pointer, 1, "double", OP_INC),&#x000A;              op_arg_dat(Coordinate.dat, OP_ALL, Coordinate.map,&#x000A;                         Coordinate.dat->dim, "double", OP_READ));&#x000A;  /* ... similar for the right-hand side */&#x000A;  op_solve(A_mat, RHS_vec, Tracer.dat);&#x000A;  /* ... clean up */&#x000A;}</textarea>
</p>
  </div>
  <div class='spacer bottom'></div>
</section>
    <section class='huge slide'>
  <div class='spacer top'></div>
  <div class='content'>
    <h1>Preliminary performance results</h1>
  </div>
  <div class='spacer bottom'></div>
</section>
    <section class='left slide'>
  <div class='spacer top'></div>
  <div class='content'>
    <h1>Experimental setup</h1>

<h2>Solver</h2>

<p>CG with Jacobi preconditioning - <strong>Dolfin:</strong> PETSc, <strong>OP2:</strong> PETSc (reference), Cusp (CUDA)</p>

<h2>CPU</h2>

<p>2 x 6 core Intel Xeon E5650 Westmere (HT off), 48GB RAM</p>

<h2>GPU</h2>

<p>Nvidia GTX480</p>

<h2>Mesh</h2>

<p>2D unstructured, 344128 triangles, square domain</p>

<h2>Dolfin</h2>

<p>Revision 6739, Tensor representation, CPP optimisations on, form compiler optimisations off</p>
  </div>
  <div class='spacer bottom'></div>
</section>
    <section class='full-background mcfc_dolfin_benchmark slide'>
      <div class='spacer top'></div>
      <div class='content'>
        
      </div>
      <div class='spacer bottom'></div>
    </section>
    <section class='left slide'>
  <div class='spacer top'></div>
  <div class='content'>
    <h1>Resources</h1>

<h2>All the code mentioned is open source and available on <em>GitHub</em>. Try it!</h2>

<h2>Manycore Form Compiler (MCFC)</h2>

<p><a href="https://github.com/gmarkall/manycore_form_compiler">https://github.com/gmarkall/manycore_form_compiler</a></p>

<h2>OP2 library</h2>

<p><a href="https://github.com/OP2/OP2-Common">https://github.com/OP2/OP2-Common</a></p>

<h2>OP2 source-to-source translator</h2>

<p><a href="https://github.com/OP2/OP2_ROSE_Fortran">https://github.com/OP2/OP2_ROSE_Fortran</a></p>

<h2>This talk</h2>

<p><a href="https://kynan.github.com/fenics-at-imperial-2012">https://kynan.github.com/fenics-at-imperial-2012</a></p>
  </div>
  <div class='spacer bottom'></div>
</section>
  </body>
</html>
